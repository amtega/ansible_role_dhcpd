---
# Configuration tasks block

- block:

  - name: search static addresses defined in other hosts
    set_fact:
      dhcpd_external_static_addresses: >
        {{ hostvars[item]['dhcpd_static_addresses'] | list }}
    when: >
      'dhcpd_server' in hostvars[item]
      and hostvars[item]['dhcpd_server'] == '{{ inventory_hostname }}'
      and 'dhcpd_static_addresses' in hostvars[item]
    with_items: "{{ groups['all'] }}"
    register: search_external_static_addresses_result

  - name: setup a fact with all static addresses
    set_fact:
      dhcpd_all_static_addresses: >
        {{ search_external_static_addresses_result.results
          | reject('skipped', 'defined')
          | map(attribute='ansible_facts')
          | map(attribute='dhcpd_external_static_addresses')
          | sum(none, [])
          | list + dhcpd_static_addresses | default([]) }}

  - name: setup a fact with all necessary static addresses include config files
    set_fact:
      dhcpd_static_include_files: >
        {{ dhcpd_all_static_addresses
          | map(attribute='hostname')
          | map('regex_replace', '$', '.conf') | list }}

  - name: setup a fact with all necessary subnet include config files
    set_fact:
      dhcpd_subnet_include_files: >
        {{ dhcpd_subnets
          | map(attribute='subnet')
          | map('regex_replace', '$', '.conf')
          | list }}

  - name: setup a fact with all necessary include files
    set_fact:
      dhcpd_include_files: >
        {{ dhcpd_static_include_files
          + dhcpd_subnet_include_files }}

  - include: search_includes.yml

  - name: delete not necessary include files
    file: path={{ item.path }} state=absent
    when: "'{{ item.path | basename }}' not in dhcpd_include_files"
    with_items: "{{ search_includes_result.files }}"

  - name: configure dhcpd subnets
    template:
      src: subnet.template.j2
      dest: "{{ dhcpd_include_files_dir }}/{{ item.subnet }}.conf"
      owner: root
      group: root
      mode: 0644
      backup: yes
    with_items: "{{ dhcpd_subnets }}"
    register: configure_dhcpd_subnets_result
    when: "not dhcpd_client_only"

  - name: configure static addresses
    template:
      src: static.template.j2
      dest: "{{ dhcpd_include_files_dir }}/{{ item.hostname }}.conf"
      owner: root
      group: root
      mode: 0644
      backup: yes
    when: "{{ item.managed | default(true) }}"
    with_items: "{{ dhcpd_all_static_addresses }}"
    register: configure_static_addresses_result

  - include: search_includes.yml

  - name: setup a fact with all remaining include files
    set_fact:
      dhcpd_include_files: >
        {{ search_includes_result.files | map(attribute='path') | list }}

  - name: create main configuration file
    template:
      src: dhcpd.template.j2
      dest: /etc/dhcp/dhcpd.conf
      owner: root
      group: root
      mode: 0644
      backup: yes
    register: create_main_config_result

  - name: restart dhcpd service
    service: name=dhcpd state=restarted enabled=yes
    delegate_to: "{{ dhcpd_server }}"
    when: >
      {{ configure_dhcpd_subnets_result.changed }}
      or {{ create_main_config_result.changed }}
      or {{ configure_static_addresses_result.changed }}

  delegate_to: "{{ dhcpd_server }}"
  tags: configure
