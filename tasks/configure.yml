---
# Configuration tasks

- block:

  - name: disable unamanged files deletion if the role is called from a clients
    set_fact:
      dhcpd_delete_unmanaged: false
    when: inventory_hostname != dhcpd_server

  - name: create configuration files for subnets
    template:
      src: subnet.template.j2
      dest: "{{ dhcpd_subnets_include_dir }}/{{ item.subnet }}.conf"
      owner: root
      group: root
      mode: 0644
      backup: no
    when: item.state == 'present'
    with_items: "{{ dhcpd_subnet_addresses }}"
    register: dhcpd_configure_subnets_result
    loop_control:
      label: "{{ item.subnet }} / {{ item.netmask }}"

  - name: remove configuration files for subnets marked as absent
    file:
      path: "{{ dhcpd_subnets_include_dir }}/{{ item.subnet }}.conf"
      state: absent
    when: item.state == 'absent'
    register: dhcpd_remove_absent_subnets_result
    with_items: "{{ dhcpd_subnet_addresses }}"
    loop_control:
      label: "{{ item.subnet}} / {{ item.netmask }}"

  - name: create configuration files for static addresses
    template:
      src: static.template.j2
      dest: "{{ dhcpd_static_include_dir }}/{{ item.hostname }}.conf"
      owner: root
      group: root
      mode: 0644
      backup: no
    when: item.state == 'present'
    with_items: "{{ dhcpd_static_addresses | default([]) }}"
    register: dhcpd_configure_static_result
    loop_control:
      label: "{{ item.hostname }} / {{ item.mac }}"

  - name: remove configuration files for static addresses marked as absent
    file:
      path: "{{ dhcpd_static_include_dir }}/{{ item.hostname }}.conf"
      state: absent
    when: item.state == 'absent'
    with_items: "{{ dhcpd_static_addresses | default([]) }}"
    register: dhcpd_remove_absent_static_result
    loop_control:
      label: "{{ item.hostname}} / {{ item.mac }}"

  - name: search include files that already exists
    find:
      paths: "{{ item }}"
      patterns: "*.conf"
    with_items:
      - "{{ dhcpd_subnets_include_dir }}"
      - "{{ dhcpd_static_include_dir }}"
    register: search_includes_result

  - name: build list of include files from existing ones
    set_fact:
      dhcpd_include_files: >-
        {{ search_includes_result.results
          | map(attribute="files")
          | sum(start=[])
          | map(attribute="path")
          | list
          | default([]) }}
    when: not dhcpd_delete_unmanaged

  - name: delete unamanged include files
    include: delete_unmanaged.yml
    when: dhcpd_delete_unmanaged
    static: false

  - block:

      - name: lock dhcpd server
        include: lock_create.yml

    rescue:

      - name: force unlock of dhcpd server
        include: lock_delete.yml

      - name: lock dhcpd server
        include: lock_create.yml

    when: >-
      dhcpd_configure_subnets_result | changed
        or dhcpd_remove_absent_subnets_result | changed
        or dhcpd_configure_static_result | changed
        or dhcpd_remove_absent_static_result | changed
        or dhcpd_delete_unmanaged_result | changed

  - debug: msg="{{ dhcpd_configure_subnets_result | changed }}"
  - debug: msg="{{ dhcpd_remove_absent_subnets_result | changed }}"
  - debug: msg="{{ dhcpd_configure_static_result | changed }}"
  - debug: msg="{{ dhcpd_remove_absent_static_result | changed }}"
  - debug: msg="{{ dhcpd_delete_unmanaged_result | changed | default(false) }}"

  - name: create dhcpd main configuration file
    template:
      src: dhcpd.template.j2
      dest: /etc/dhcp/dhcpd.conf
      owner: root
      group: root
      mode: 0644
      backup: no
    when:
        dhcpd_configure_subnets_result | changed
          or dhcpd_remove_absent_subnets_result | changed
          or dhcpd_configure_static_result | changed
          or dhcpd_remove_absent_static_result | changed
          or dhcpd_delete_unmanaged_result | changed
    notify:
      - dhcpd restart

  always:

    - name: unlock dhcpd server
      include: lock_delete.yml

  delegate_to: "{{ dhcpd_server }}"
  tags:
    - role::dhcpd
    - role::dhcpd::configure
